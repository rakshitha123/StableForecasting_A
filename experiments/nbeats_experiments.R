library(data.table)

BASE_DIR <- "StableForecasting"


# Execution of helper scripts
source(file.path(BASE_DIR, "utils", "error_calculator.R", fsep = "/"))
source(file.path(BASE_DIR, "utils", "interpolate.R", fsep = "/"))


# A wrapper function to calculate the errors of the forecasts generated by the stable N-BEATS framework
evaluate_nbeats <- function(path, file_name){
  nbeats_output <- fread(file.path(BASE_DIR, path)) # Provide an output file generated by the stable N-BEATS framework at: https://github.com/KU-Leuven-LIRIS/n-beats-s/tree/main
  forecasts_acc <- nbeats_output[nbeats_output$type == "forecast", 3:(ncol(nbeats_output)-1)]
  test_set <- nbeats_output[nbeats_output$type == "actual", 3:(ncol(nbeats_output)-1)]
  calculate_errors(as.matrix(forecasts_acc), as.matrix(test_set), file_name)
  
  all_forecasts <- nbeats_output[nbeats_output$type == "forecast", 1:(ncol(nbeats_output)-1)]
  calculate_vertical_stability(all_forecasts, file_name)
  calculate_vertical_stability(all_forecasts, file_name, TRUE, TRUE)
  
  calculate_horizontal_stability(all_forecasts, file_name)
  calculate_horizontal_stability(all_forecasts, file_name, TRUE, TRUE)
}



# Experiments

# Run the stable N-BEATS framework and obtain forecasts before trying the following experiments. 
# Update the "path" variable used by all functions with the path of the output file obtained from the stable N-BEATS framework.


# Evaluation of NBEATS
evaluate_nbeats("n-beats-s-main/m4m_nbeats_test_smart-sweep-1.csv", "nbeats_m4_monthly")
evaluate_nbeats("n-beats-s-main/m3m_nbeats_test_resilient-sweep-1.csv", "nbeats_m3_monthly")


# Evaluation of Stable NBEATS
evaluate_nbeats("n-beats-s-main/m4m_nbeats_stability_test_fluent-sweep-1.csv", "nbeats_stable_m4_monthly")
evaluate_nbeats("n-beats-s-main/m3m_nbeats_stability_test_cosmic-sweep-1.csv", "nbeats_stable_m3_monthly")



# Partial interpolation experiments

# Vertical Stability
vertical_partial_interpolate("n-beats-s-main/m4m_nbeats_test_smart-sweep-1.csv", "nbeats_m4_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1)) 
vertical_partial_interpolate("n-beats-s-main/m3m_nbeats_test_resilient-sweep-1.csv", "nbeats_m3_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1))

# Horizontal Stability
horizontal_partial_interpolate("n-beats-s-main/m3m_nbeats_test_resilient-sweep-1.csv", "nbeats_m3_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1))
horizontal_partial_interpolate("n-beats-s-main/m4m_nbeats_test_smart-sweep-1.csv", "nbeats_m4_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1)) 



# Full interpolation experiments

# Vertical Stability
vertical_full_interpolate("n-beats-s-main/m4m_nbeats_test_smart-sweep-1.csv", "nbeats_m4_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1))
vertical_full_interpolate("n-beats-s-main/m3m_nbeats_test_resilient-sweep-1.csv", "nbeats_m3_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1))

# Horizontal Stability
horizontal_full_interpolate("n-beats-s-main/m3m_nbeats_test_resilient-sweep-1.csv", "nbeats_m3_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1))
horizontal_full_interpolate("n-beats-s-main/m4m_nbeats_test_smart-sweep-1.csv", "nbeats_m4_monthly", c(0.2, 0.4, 0.5, 0.6, 0.8, 1))
